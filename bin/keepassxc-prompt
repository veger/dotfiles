#!/usr/bin/env bash
#
# Add to ~/.ssh/config:
#
#Host *
#	Match exec "test \"${GIT_TERMINAL_PROMPT:-1}\" != 0"
#		ProxyCommand ~/.ssh/keepassxc-prompt %h %p
set -euo pipefail

host="$1"
port="$2"

timeout=120
start=$(date +%s)

if ! ssh-add -l >/dev/null 2>&1; then
  # Open DB unlock screen
  keepassxc >/dev/null 2>&1 &

  # Wait until identities appear (i.e., DB unlocked and SSH agent integration active)
  while ! ssh-add -l >/dev/null 2>&1; do
    now=$(date +%s)
    if [ $((now - start)) -ge "$timeout" ]; then
      echo "Timed out waiting for KeePassXC to be unlocked." >&2
      exit 1
    fi
    sleep 1
  done
fi

# --- Open raw TCP connection for SSH using bash /dev/tcp ---
# This replaces "nc host port".
exec bash -c '
  set -euo pipefail
  host="$1"; port="$2"

  # Open bidirectional TCP FD 3
  exec 3<>"/dev/tcp/${host}/${port}"

  # Pump stdin -> socket and socket -> stdout
  cat <&3 &
  cat >&3
' _ "$host" "$port"
